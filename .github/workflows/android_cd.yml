name: test CD

on:
    push:
        branches:
            - master
    pull_request:
        branches:
            - master

jobs:
    cd:
        name: Continuous Deployment
        runs-on: ubuntu-latest

        env:
            GOOGLE_SERVICES_JSON: ${{ secrets.GOOGLE_SERVICES_JSON }}

        steps:
            # 1. Code Checkout
            - name: Checkout code
              uses: actions/checkout@v4

            # 2. Gradle Cache
            - name: Cache Gradle dependencies
              uses: actions/cache@v4
              with:
                  path: |
                      ~/.gradle/caches
                      ~/.gradle/wrapper
                  key: ${{ runner.os }}-gradle-${{ hashFiles('**/*.gradle*', '**/gradle-wrapper.properties') }}
                  restore-keys: |
                      ${{ runner.os }}-gradle-

            # 3. JDK 17
            - name: Set up JDK 17
              uses: actions/setup-java@v4
              with:
                  java-version: 17
                  distribution: 'corretto'
                  cache: gradle

            # 4. Grant Execute Permission
            - name: Change gradlew permissions
              run: chmod +x gradlew

            # 5. keystore, google-services
            - name: Decode And Save Keystore Base64
              run: |
                  echo "${{ secrets.KEYSTORE_BASE64 }}" | base64 --decode > app/keystore.jks
            - name: Create google-services.json
              run: echo "$GOOGLE_SERVICES_JSON" > app/google-services.json

            # 6. Install Firebase CLI
            - name: Install Firebase CLI
              run: curl -sL https://firebase.tools | bash

            # # 6. Decode google-services.json
            # - name: Decode google-services.json
            #   env:
            #       FIREBASE_SECRET: ${{ secrets.FIREBASE_SECRET }}
            #   run: echo $FIREBASE_SECRET | base64 --decode > app/google-services.json

            # Add Local Properties
            - name: Add Local Properties
              env:
                  BASE_URL: ${{ secrets.KAKAO_NATIVE_APP_KEY }}
                  AMPLITUDE_API_KEY: ${{ secrets.KAKAO_NATIVE_APP_KEY_MANIFEST }}
              run: |
                  echo -e "kakao_NATIVE_APP_KEY=$KAKAO_NATIVE_APP_KEY\kakao_NATIVE_APP_KEY_MANIFEST=$KAKAO_NATIVE_APP_KEY_MANIFEST" >> local.properties

            # 7. Debug Local Properties Check
            -   name: Debug Local Properties
                run: cat local.properties

            # # 8. Ktlint
            # - name: Run Ktlint Check
            #   run: ./gradlew ktlintCheck --stacktrace

            # # 9. Debug APK Build
            # - name: Build Debug APK
            #   run: ./gradlew assembleDebug --stacktrace

            # # 10. Release AAB Build
            # - name: Build Release AAB
            #   run: ./gradlew bundleRelease --stacktrace

            # 11. Release APK Build
            - name: Build Release APK
              run: ./gradlew assembleRelease --stacktrace

            # # 12. AAB Artifact Upload
            # - name: Upload Release AAB
            #   uses: actions/upload-artifact@v4
            #   with:
            #       name: release-aab
            #       path: app/build/outputs/bundle/release/app-release.aab

            # 13. APK Artifact Upload
            - name: Upload Release APK
              uses: actions/upload-artifact@v4
              with:
                  name: release-apk
                  path: app/build/outputs/apk/release/app-release.apk

            # # 14. Set up Firebase Service Account Credentials
            # - name: Set up Firebase Service Account Credentials
            #   env:
            #       GOOGLE_APPLICATION_CREDENTIALS_JSON: ${{ secrets.GOOGLE_APPLICATION_CREDENTIALS_JSON }}
            #   run: |
            #       echo "$GOOGLE_APPLICATION_CREDENTIALS_JSON" | base64 --decode > $HOME/firebase-credentials.json
            #       echo "ğŸ”¥ Firebase Credentials JSON ìƒì„± ì™„ë£Œ!"
            #       ls -l $HOME/firebase-credentials.json
            #       export GOOGLE_APPLICATION_CREDENTIALS=$HOME/firebase-credentials.json
            #       echo "GOOGLE_APPLICATION_CREDENTIALS=$GOOGLE_APPLICATION_CREDENTIALS"

            # # 15. Firebase CLI ì¸ì¦ í™•ì¸
            # - name: Check Firebase CLI Authentication
            #   run: |
            #       export GOOGLE_APPLICATION_CREDENTIALS=$HOME/firebase-credentials.json

            #       echo "ğŸ“Œ GOOGLE_APPLICATION_CREDENTIALS ì„¤ì • ê°’:"
            #       echo $GOOGLE_APPLICATION_CREDENTIALS
            #       ls -l $GOOGLE_APPLICATION_CREDENTIALS

            #       echo "ğŸ“Œ í˜„ì¬ Firebase í”„ë¡œì íŠ¸ ëª©ë¡ í™•ì¸:"
            #       firebase projects:list || (echo "âŒ Firebase ì¸ì¦ ì‹¤íŒ¨!"; exit 1)

            # # 16. Firebase App Distribution Upload
            # - name: Upload APK to Firebase App Distribution
            #   env:
            #       GOOGLE_APPLICATION_CREDENTIALS: $HOME/firebase-credentials.json
            #       FIREBASE_APP_ID: ${{ secrets.FIREBASE_APP_ID }}
            #   run: |
            #       echo "ğŸ”¥ FIREBASE_APP_ID í™•ì¸: $FIREBASE_APP_ID"

            #       # ë§Œì•½ FIREBASE_APP_IDê°€ ì—†ìœ¼ë©´ ì—ëŸ¬ ì¶œë ¥ í›„ ì¢…ë£Œ
            #       if [ -z "$FIREBASE_APP_ID" ]; then
            #         echo "âŒ ERROR: FIREBASE_APP_IDê°€ ì„¤ì •ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤. GitHub Secretsì—ì„œ í™•ì¸í•˜ì„¸ìš”."
            #         exit 1
            #       fi

            #       # GOOGLE_APPLICATION_CREDENTIALSë¥¼ ë‹¤ì‹œ ì„¤ì •
            #       export GOOGLE_APPLICATION_CREDENTIALS=$HOME/firebase-credentials.json
            #       echo "GOOGLE_APPLICATION_CREDENTIALS=$GOOGLE_APPLICATION_CREDENTIALS"

            #       firebase appdistribution:distribute app/build/outputs/apk/release/app-release.apk \
            #       --app "$FIREBASE_APP_ID" \
            #       --release-notes "ğŸš€ ìƒˆë¡œìš´ ë°ëª¨ ë²„ì „ì´ ë°°í¬ë˜ì—ˆìŠµë‹ˆë‹¤!" \
            #       --groups "orbit-tester-group"

            - name: Upload to Firebase App Distribution
              uses: wzieba/Firebase-Distribution-Github-Action@v1
              with:
                  appId: ${{secrets.FIREBASE_APP_ID}}
                  serviceCredentialsFileContent: ${{ secrets.CREDENTIAL_FILE_CONTENT }}
                  groups: test
                  file: app/build/outputs/apk/release/app-release.apk

            # 17. Notify Discord
            - name: Notify Discord
              env:
                  DISCORD_WEBHOOK_URL: ${{ secrets.DISCORD_WEBHOOK_URL }}
              run: |
                  curl -H "Content-Type: application/json" \
                  -X POST \
                  -d '{"content": "ğŸš€ ìƒˆë¡œìš´ ë°ëª¨ ë²„ì „ì´ Firebase App Distributionì— ì—…ë¡œë“œë˜ì—ˆìŠµë‹ˆë‹¤!\nAPK ë‹¤ìš´ë¡œë“œ: https://appdistribution.firebase.google.com"}' \
                  $DISCORD_WEBHOOK_URL
